/*!
 * Crosslinks - Manage automatic crosslinks
 * Version: 1.2.2
 * Build date: 2019-05-22
 */

var crosslinks=function(e){return e=e||{},Ext.applyIf(e,{}),crosslinks.superclass.constructor.call(this,e),this};Ext.extend(crosslinks,Ext.Component,{page:{},window:{},grid:{},tree:{},panel:{},combo:{},config:{},util:{}}),Ext.reg("crosslinks",crosslinks),Crosslinks=new crosslinks,Crosslinks.combo.Resource=function(e){e=e||{},Ext.applyIf(e,{name:"resource",hiddenName:"resource",displayField:"pagetitle",valueField:"id",fields:["id","pagetitle"],pageSize:10,minChars:1,editable:!0,triggerAction:"all",typeAhead:!1,forceSelection:!0,selectOnFocus:!1,url:Crosslinks.config.connectorUrl,mode:"remote",baseParams:{action:"mgr/resource/getlist",combo:!0}}),Crosslinks.combo.Resource.superclass.constructor.call(this,e)},Ext.extend(Crosslinks.combo.Resource,MODx.combo.ComboBox),Ext.reg("crosslinks-combo-resource",Crosslinks.combo.Resource),Crosslinks.grid.JsonGrid=function(e){e=e||{},this.ident=e.ident||"crosslinks-mecitem"+Ext.id(),this.buttonColumnTpl=new Ext.XTemplate('<tpl for="."><tpl if="action_buttons !== null"><ul class="action-buttons"><tpl for="action_buttons"><li><i class="icon {className} icon-{icon}" title="{text}"></i></li></tpl></ul></tpl></tpl>',{compiled:!0}),this.hiddenField=new Ext.form.TextArea({name:e.hiddenName||e.name,hidden:!0}),Ext.applyIf(e,{id:this.ident+"-json-grid",fields:["id","key","value","rank"],autoHeight:!0,store:new Ext.data.JsonStore({fields:["id","key","value","rank"],data:Ext.util.JSON.decode(e.value)}),enableDragDrop:!0,ddGroup:this.ident+"-json-grid-dd",autoExpandColumn:"value",labelStyle:"position: absolute",style:"padding-top: 10px",columns:[{header:_("crosslinks.jsongrid_key"),dataIndex:"key",editable:!0,editor:{xtype:"textfield",allowBlank:!1,listeners:{keydown:{fn:this.saveValue,scope:this}}},width:80},{header:_("crosslinks.jsongrid_value"),dataIndex:"value",editable:!0,editor:{xtype:"textfield",allowBlank:!1,listeners:{keydown:{fn:this.saveValue,scope:this}}},width:80},{renderer:{fn:this.buttonColumnRenderer,scope:this},width:30,align:"right"},{dataIndex:"id",hidden:!0},{dataIndex:"rank",hidden:!0}],tbar:["->",{text:'<i class="icon icon-plus"></i> '+_("add"),cls:"primary-button",handler:this.addEntry,scope:this}],listeners:{render:{fn:this.renderListener,scope:this}}}),Crosslinks.grid.JsonGrid.superclass.constructor.call(this,e)},Ext.extend(Crosslinks.grid.JsonGrid,MODx.grid.LocalGrid,{windows:{},getMenu:function(){var e=[];return e.push({text:_("remove"),handler:this.removeEntry}),e},addEntry:function(){var e=new(this.getStore().recordType)({key:"",value:""});this.getStore().insert(0,e),this.getView().refresh(),this.getSelectionModel().selectRow(0)},removeEntry:function(){Ext.Msg.confirm(_("remove")||"",_("confirm_remove")||"",function(e){if("yes"===e){var t=this.getStore(),s=this.getSelectionModel().getSelections();if(!s.length)return!1;for(var i=0;i<s.length;i++){s[i].id;var n=t.findBy(function(e,t){if(e.id===t)return!0});t.removeAt(n)}this.getView().refresh(),this.saveValue()}},this)},renderListener:function(c){new Ext.dd.DropTarget(c.container,{copy:!1,ddGroup:this.ident+"-json-grid-dd",notifyDrop:function(e,t,s){var i=c.store,n=c.getSelectionModel(),r=n.getSelections(),o=e.getDragData(t);if(o){var l=o.rowIndex;if(void 0!==l){for(var a=0;a<r.length;a++)i.remove(i.getById(r[a].id));i.insert(l,s.selections),n.clearSelections()}}c.getView().refresh(),c.saveValue()}}),this.add(this.hiddenField),this.saveValue()},buttonColumnRenderer:function(){var e={action_buttons:[{className:"remove",icon:"trash-o",text:_("remove")}]};return this.buttonColumnTpl.apply(e)},onClick:function(e){var t=e.getTarget();if("icon"===t.className.split(" ")[0]){var s=t.className.split(" ")[1],i=this.getSelectionModel().getSelected();switch(this.menu.record=i.data,s){case"remove":this.removeEntry(i,e)}}},saveValue:function(){var s=[];Ext.each(this.getStore().getRange(),function(e){if(e.data.key){var t={};t[e.data.key]=e.data.value,s.push(t)}}),this.hiddenField.setValue(Ext.util.JSON.encode(s))}}),Ext.reg("crosslinks-json-grid",Crosslinks.grid.JsonGrid),Crosslinks.combo.JsonGrid=function(e){e=e||{},Ext.applyIf(e,{store:new Ext.data.JsonStore({fields:["name","targetwidth","targetheight","targetRatio"],data:e.data}),mode:"local",displayField:"name",valueField:"name",submitValue:!1,triggerAction:"all",listeners:{select:{fn:this.selectConfig,scope:this}}}),Crosslinks.combo.JsonGrid.superclass.constructor.call(this,e)},Ext.extend(Crosslinks.combo.JsonGrid,MODx.combo.ComboBox,{selectConfig:function(e,t){Ext.getCmp("inopt_targetWidth"+this.config.tvId).setValue(t.data.targetwidth),Ext.getCmp("inopt_targetHeight"+this.config.tvId).setValue(t.data.targetheight),Ext.getCmp("inopt_targetRatio"+this.config.tvId).setValue(t.data.targetRatio)}}),Ext.reg("crosslinks-json-combo",Crosslinks.combo.JsonGrid),Crosslinks.panel.Home=function(e){e=e||{},Ext.applyIf(e,{cls:"container home-panel"+(Crosslinks.config.debug?" debug":""),defaults:{collapsible:!1,autoHeight:!0},items:[{html:"<h2>"+_("crosslinks.management")+"</h2>"+(Crosslinks.config.debug?'<div class="ribbon top-right"><span>'+_("crosslinks.debug_mode")+"</span></div>":""),border:!1,cls:"modx-page-header"},{defaults:{autoHeight:!0},border:!0,items:[{xtype:"crosslinks-panel-overview"}]},{cls:"treehillstudio_about",html:'<img width="133" height="40" src="'+Crosslinks.config.assetsUrl+'img/mgr/treehill-studio-small.png" srcset="'+Crosslinks.config.assetsUrl+'img/mgr/treehill-studio-small@2x.png 2x" alt="Treehill Studio">',listeners:{afterrender:function(e){e.getEl().select("img").on("click",function(){var e='<span style="display: inline-block; text-align: center"><img src="'+Crosslinks.config.assetsUrl+'img/mgr/treehill-studio.png" srcset="'+Crosslinks.config.assetsUrl+'img/mgr/treehill-studio@2x.png 2x" alt"Treehill Studio"><br>© 2018-2019 by <a href="https://treehillstudio.com" target="_blank">treehillstudio.com</a></span>';Ext.Msg.show({title:_("crosslinks")+" "+Crosslinks.config.version,msg:e,buttons:Ext.Msg.OK,cls:"treehillstudio_window",width:330})})}}}]}),Crosslinks.panel.Home.superclass.constructor.call(this,e)},Ext.extend(Crosslinks.panel.Home,MODx.Panel),Ext.reg("crosslinks-panel-home",Crosslinks.panel.Home),Crosslinks.panel.HomeTab=function(e){e=e||{},Ext.applyIf(e,{id:"crosslinks-panel-"+e.tabtype,title:e.title,items:[{html:"<p>"+e.description+"</p>",border:!1,cls:"panel-desc"},{layout:"form",cls:"x-form-label-left main-wrapper",defaults:{autoHeight:!0},border:!0,items:[{id:"crosslinks-panel-"+e.tabtype+"-grid",xtype:"crosslinks-grid-"+e.tabtype,preventRender:!0}]}]}),Crosslinks.panel.HomeTab.superclass.constructor.call(this,e)},Ext.extend(Crosslinks.panel.HomeTab,MODx.Panel),Ext.reg("crosslinks-panel-hometab",Crosslinks.panel.HomeTab),Crosslinks.panel.Overview=function(e){e=e||{},this.ident="crosslinks-panel-overview"+Ext.id(),this.panelOverviewTabs=[{xtype:"crosslinks-panel-hometab",title:_("crosslinks.links"),description:_("crosslinks.links_desc"),tabtype:"links"}],Crosslinks.config.is_admin&&this.panelOverviewTabs.push({xtype:"crosslinks-panel-settings",title:_("crosslinks.settings"),description:_("crosslinks.settings_desc"),tabtype:"settings"}),Ext.applyIf(e,{id:this.ident,items:[{xtype:"modx-tabs",stateful:!0,stateId:"crosslinks-panel-overview",stateEvents:["tabchange"],getState:function(){return{activeTab:this.items.indexOf(this.getActiveTab())}},autoScroll:!0,deferredRender:!1,forceLayout:!0,defaults:{layout:"form",autoHeight:!0,hideMode:"offsets"},items:this.panelOverviewTabs,listeners:{tabchange:function(e,t){"settings"===t.tabtype?Ext.getCmp("crosslinks-grid-system-settings").getStore().reload():"crosslinks-panel-hometab"===t.xtype&&Ext.getCmp("crosslinks-panel-"+t.tabtype+"-grid")&&Ext.getCmp("crosslinks-panel-"+t.tabtype+"-grid").getStore().reload()}}}]}),Crosslinks.panel.Overview.superclass.constructor.call(this,e)},Ext.extend(Crosslinks.panel.Overview,MODx.Panel),Ext.reg("crosslinks-panel-overview",Crosslinks.panel.Overview),Crosslinks.grid.Links=function(e){e=e||{},this.buttonColumnTpl=new Ext.XTemplate('<tpl for="."><tpl if="action_buttons !== null"><ul class="action-buttons"><tpl for="action_buttons"><li><i class="icon {className} icon-{icon}" title="{text}"></i></li></tpl></ul></tpl></tpl>',{compiled:!0}),this.ident="crosslinks-links"+Ext.id(),Ext.applyIf(e,{id:this.ident+"-crosslinks-grid-links",url:Crosslinks.config.connectorUrl,baseParams:{action:"mgr/link/getlist"},fields:["id","text","resource","pagetitle","parameter"],autoHeight:!0,paging:!0,remoteSort:!1,autoExpandColumn:"text",columns:[{header:_("crosslinks.link_text"),dataIndex:"text",sortable:!0,width:80},{header:_("crosslinks.link_resource"),dataIndex:"resource",sortable:!0,width:80,renderer:function(e,t,s){return s.data.pagetitle}},{header:_("crosslinks.link_parameter"),dataIndex:"parameter",sortable:!1,width:30,renderer:function(e){return'<div style="text-align:center"><i class="icon '+("[]"!==e?"icon-check":"icon-times")+" "+("[]"!==e?"green":"red")+'"></i></div>'}},{renderer:{fn:this.buttonColumnRenderer,scope:this},width:30}],tbar:[{text:_("crosslinks.link_create"),cls:"primary-button",handler:this.createLink},"->",{xtype:"textfield",id:this.ident+"-crosslinks-filter-search",emptyText:_("search")+"…",submitValue:!1,listeners:{change:{fn:this.search,scope:this},render:{fn:function(e){new Ext.KeyMap(e.getEl(),{key:Ext.EventObject.ENTER,fn:function(){return this.fireEvent("change",this),this.blur(),!0},scope:e})},scope:this}}},{xtype:"button",id:this.ident+"-crosslinks-filter-clear",cls:"x-form-filter-clear",text:_("filter_clear"),listeners:{click:{fn:this.clearFilter,scope:this}}}]}),Crosslinks.grid.Links.superclass.constructor.call(this,e)},Ext.extend(Crosslinks.grid.Links,MODx.grid.Grid,{windows:{},getMenu:function(){var e=[];e.push({text:_("crosslinks.link_update"),handler:this.updateLink}),e.push("-"),e.push({text:_("crosslinks.link_duplicate"),handler:this.duplicateLink}),e.push("-"),e.push({text:_("crosslinks.link_remove"),handler:this.removeLink}),this.addContextMenuItem(e)},createLink:function(e,t){this.createUpdateLink(e,t,!1)},updateLink:function(e,t){this.createUpdateLink(e,t,!0)},createUpdateLink:function(e,t,s){var i;if(s){if(!this.menu.record||!this.menu.record.id)return!1;i=this.menu.record}else i={parameter:"{}"};var n=MODx.load({xtype:"crosslinks-window-link-create-update",isUpdate:s,title:s?_("crosslinks.link_update"):_("crosslinks.link_create"),record:i,listeners:{success:{fn:this.refresh,scope:this}}});n.fp.getForm().setValues(i),n.show(t.target)},duplicateLink:function(e,t){if(!this.menu.record)return!1;var s=Ext.apply({},this.menu.record);s.text=_("crosslinks.duplicate")+" "+s.text,s.id=null;var i=MODx.load({xtype:"crosslinks-window-link-create-update",isUpdate:!1,title:_("crosslinks.link_duplicate"),record:s,listeners:{success:{fn:this.refresh,scope:this}}});i.fp.getForm().setValues(s),i.show(t.target)},removeLink:function(){if(!this.menu.record)return!1;MODx.msg.confirm({title:_("crosslinks.link_remove"),text:_("crosslinks.link_remove_confirm"),url:this.config.url,params:{action:"mgr/link/remove",id:this.menu.record.id},listeners:{success:{fn:this.refresh,scope:this}}})},search:function(e){this.getStore().baseParams.query=e.getValue(),this.getBottomToolbar().changePage(1),this.refresh()},clearFilter:function(){this.getStore().baseParams.query="",Ext.getCmp(this.ident+"-crosslinks-filter-search").reset(),this.getBottomToolbar().changePage(1),this.refresh()},buttonColumnRenderer:function(){var e={action_buttons:[{className:"update",icon:"pencil-square-o",text:_("crosslinks.link_update")},{className:"duplicate",icon:"clone",text:_("crosslinks.link_duplicate")},{className:"remove",icon:"trash-o",text:_("crosslinks.link_remove")}]};return this.buttonColumnTpl.apply(e)},onClick:function(e){var t=e.getTarget();if("icon"===t.className.split(" ")[0]){var s=t.className.split(" ")[1],i=this.getSelectionModel().getSelected();switch(this.menu.record=i.data,s){case"remove":this.removeLink(i,e);break;case"duplicate":this.duplicateLink(i,e);break;case"update":this.updateLink(i,e)}}}}),Ext.reg("crosslinks-grid-links",Crosslinks.grid.Links),Crosslinks.window.CreateUpdateLink=function(e){e=e||{},this.ident=e.ident||"culink"+Ext.id(),Ext.applyIf(e,{id:this.ident,url:Crosslinks.config.connectorUrl,action:e.isUpdate?"mgr/link/update":"mgr/link/create",width:400,autoHeight:!0,closeAction:"close",cls:"modx-window crosslinks-window",fields:[{xtype:"textfield",fieldLabel:_("crosslinks.link_text"),name:"text",id:this.ident+"-text",anchor:"100%",allowBlank:!1},{xtype:"crosslinks-combo-resource",fieldLabel:_("crosslinks.link_resource"),name:"resource",id:this.ident+"-resource",anchor:"100%"},{xtype:"crosslinks-json-grid",fieldLabel:_("crosslinks.link_parameter"),name:"parameter",id:this.ident+"-parameter",cls:"modx-grid modx-grid-small",anchor:"100%"},{xtype:"hidden",name:"id"}]}),Crosslinks.window.CreateUpdateLink.superclass.constructor.call(this,e)},Ext.extend(Crosslinks.window.CreateUpdateLink,MODx.Window),Ext.reg("crosslinks-window-link-create-update",Crosslinks.window.CreateUpdateLink),Crosslinks.panel.Settings=function(e){e=e||{},Ext.applyIf(e,{id:"crosslinks-panel-settings",title:_("crosslinks.settings"),items:[{html:"<p>"+_("crosslinks.settings_desc")+"</p>",border:!1,cls:"panel-desc"},{xtype:"crosslinks-grid-system-settings",id:"crosslinks-grid-system-settings",cls:"main-wrapper",preventSaveRefresh:!0}]}),Crosslinks.panel.Settings.superclass.constructor.call(this,e)},Ext.extend(Crosslinks.panel.Settings,MODx.Panel),Ext.reg("crosslinks-panel-settings",Crosslinks.panel.Settings),Crosslinks.grid.SystemSettings=function(e){(e=e||{}).baseParams={action:"system/settings/getList",namespace:"crosslinks",area:MODx.request.area},Crosslinks.grid.SystemSettings.superclass.constructor.call(this,e)},Ext.extend(Crosslinks.grid.SystemSettings,MODx.grid.SettingsGrid,{_showMenu:function(e,t,s){s.stopEvent(),s.preventDefault(),this.menu.record=this.getStore().getAt(t).data,this.getSelectionModel().isSelected(t)||this.getSelectionModel().selectRow(t),this.menu.removeAll();var i=[];this.menu.record.menu?i=this.menu.record.menu:i.push({text:_("setting_update"),handler:this.updateSetting}),0<i.length&&(this.addContextMenuItem(i),this.menu.showAt(s.xy))},updateSetting:function(e,t){var s=this.menu.record;s.fk=Ext.isDefined(this.config.fk)?this.config.fk:0;var i=MODx.load({xtype:"modx-window-setting-update",url:Crosslinks.config.connectorUrl,action:"mgr/settings/update",record:s,grid:this,listeners:{success:{fn:function(){this.refresh()},scope:this}}});i.reset(),i.setValues(s),i.show(t.target)},clearFilter:function(){var e="crosslinks",t=MODx.request.area?MODx.request.area:"";this.getStore().baseParams=this.initialConfig.baseParams;var s=Ext.getCmp("modx-filter-area");s&&(s.store.baseParams.namespace=e,s.store.load(),s.reset()),Ext.getCmp("modx-filter-namespace").setValue(e),Ext.getCmp("modx-filter-key").reset(),this.getStore().baseParams.namespace=e,this.getStore().baseParams.area=t,this.getStore().baseParams.key="",this.getBottomToolbar().changePage(1)},filterByKey:function(e,t,s){return this.getStore().baseParams.key=t,this.getStore().baseParams.namespace="crosslinks",this.getBottomToolbar().changePage(1),!0},filterByNamespace:function(e,t,s){this.getStore().baseParams.namespace="crosslinks",this.getStore().baseParams.area="",this.getBottomToolbar().changePage(1);var i=Ext.getCmp("modx-filter-area");if(i){var n=i.store;n.baseParams.namespace="crosslinks",n.removeAll(),n.load(),i.setValue("")}},listeners:{afterrender:function(){this.topToolbar.items.items[0].hide(),this.topToolbar.items.items[2].hide()}}}),Ext.reg("crosslinks-grid-system-settings",Crosslinks.grid.SystemSettings),Crosslinks.page.Home=function(e){e=e||{},Ext.applyIf(e,{components:[{xtype:"crosslinks-panel-home",renderTo:"crosslinks-panel-home"}]}),Crosslinks.page.Home.superclass.constructor.call(this,e)},Ext.extend(Crosslinks.page.Home,MODx.Component),Ext.reg("crosslinks-page-home",Crosslinks.page.Home);